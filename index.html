<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ูุธุงู ูุฏุฑุณุฉ ูุฒูุฏ ุจู ุงูุญุงุฑุซ</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary: #1a2a6c; 
            --success: #27ae60; 
            --danger: #c0392b; 
            --late: #d35400; 
            --bg: #f4f7f9; 
            --dark: #2c3e50; 
            --accent: #f39c12; 
            --whatsapp: #25d366;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 10px; 
            padding-bottom: 100px; 
            direction: rtl; 
        }

        .card { background: #ffffff; border-radius: 12px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        
        .live-info { background: linear-gradient(135deg, var(--primary), #b21f1f); color: white; padding: 10px; border-radius: 12px; margin-bottom: 15px; text-align: center; display: flex; justify-content: space-around; font-size: 0.8rem; }
        .header-card { border-bottom: 4px solid var(--primary); text-align: center; cursor: pointer; }
        
        .search-container { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--accent); outline: none; box-sizing: border-box; font-weight: bold; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 2000; border-radius: 0 0 10px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.9rem; }
        .search-item:hover { background: #f8f9fa; }
        
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .history-table th { background: var(--dark); color: white; padding: 8px; }
        .history-table td { padding: 8px; border: 1px solid #eee; text-align: center; }

        .class-selector-wrapper { margin-bottom: 15px; text-align: right; }
        .class-label { display: block; font-weight: bold; color: var(--primary); margin-bottom: 8px; font-size: 0.9rem; }
        select { padding: 14px; border-radius: 10px; border: 2px solid #ddd; width: 100%; font-size: 1rem; outline: none; background-color: #fff; font-weight: bold; color: var(--dark); }

        .lessons-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        .lesson-btn { 
            background: #fff; border: 2px solid #eee; padding: 8px 15px; 
            border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 0.85rem;
            transition: all 0.3s ease; color: #555;
        }
        .lesson-btn.active { 
            background: var(--accent); color: white; border-color: var(--accent); 
            transform: scale(1.05); box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }

        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-top: 15px; display: none; }
        .stat-item { padding: 8px 4px; border-radius: 8px; text-align: center; font-size: 0.75rem; color: white; font-weight: bold; }
        .stat-n { background: var(--dark); }
        .stat-p { background: var(--success); }
        .stat-a { background: var(--danger); }
        .stat-perc { background: #3498db; grid-column: span 1.5; font-size: 0.7rem; }
        .stat-perc-a { background: #9b59b6; grid-column: span 1.5; font-size: 0.7rem; }

        .record-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .record-table td { padding: 12px 5px; border-bottom: 1px solid #f0f0f0; }
        
        .status-select { width: 100%; padding: 10px; font-weight: bold; border-radius: 8px; font-size: 1rem; border: 2px solid #eee; text-align: center; }
        .status-p { border-color: var(--success); color: var(--success); }
        .status-a { border-color: var(--danger); color: var(--danger); }
        .status-l { border-color: var(--late); color: var(--late); }

        .btn-save { background: var(--success); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; font-size: 1.2rem; }

        .school-summary { background: var(--dark); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .summary-box span { display: block; font-size: 1.2rem; font-weight: 800; color: var(--accent); }
        
        .class-table { width: 100%; font-size: 0.75rem; border-collapse: separate; border-spacing: 0 4px; }
        .class-table th { background: var(--primary); color: white; padding: 12px 4px; }
        .class-table td { padding: 10px 4px; background: #fff; border-top: 1px solid #eee; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; }

        .class-report-card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .class-report-header { background: var(--primary); color: white; padding: 10px 15px; font-weight: bold; border-bottom: 3px solid var(--accent); display: flex; justify-content: space-between; }
        
        .student-absent-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; background: #fff; }
        .wa-single-btn { background: var(--whatsapp); color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 0.7rem; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 4px; }

        .page-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 3px solid var(--primary); padding: 10px 0; text-align: center; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .date-picker-container { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 2px solid var(--primary); }
        .date-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; font-weight: bold; text-align: center; }
        .btn-export-all { background: var(--dark); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="live-info">
    <div>๐ <b id="liveDate"></b></div>
    <div>โฐ <b id="liveTime"></b></div>
</div>

<div class="card header-card" onclick="adminShortcut()">
    <h3 style="margin:0 0 10px 0; color:var(--primary);">๐ด๐ฒ ูุฏุฑุณุฉ ูุฒูุฏ ุจู ุงูุญุงุฑุซ</h3>
    
    <div class="class-selector-wrapper">
        <label class="class-label">1. ุงุฎุชุฑ ุงูุตู ุงูุฏุฑุงุณู:</label>
        <select id="classSelect" onchange="fetchClassData()">
            <option value="">-- ุงุถุบุท ููุงุฎุชูุงุฑ --</option>
            <optgroup label="ุฎุงูุณ"><option value="5-1">ุฎุงูุณ 1</option><option value="5-2">ุฎุงูุณ 2</option><option value="5-3">ุฎุงูุณ 3</option></optgroup>
            <optgroup label="ุณุงุฏุณ"><option value="6-1">ุณุงุฏุณ 1</option><option value="6-2">ุณุงุฏุณ 2</option></optgroup>
            <optgroup label="ุณุงุจุน"><option value="7-1">ุณุงุจุน 1</option><option value="7-2">ุณุงุจุน 2</option><option value="7-3">ุณุงุจุน 3</option></optgroup>
            <optgroup label="ุซุงูู"><option value="8-1">ุซุงูู 1</option><option value="8-2">ุซุงูู 2</option></optgroup>
        </select>
    </div>

    <label class="class-label">2. ุงุฎุชุฑ ุงูุญุตุฉ ุงูุญุงููุฉ:</label>
    <div class="lessons-container" id="lessonGroup">
        <button class="lesson-btn active" onclick="setLesson(1, this)">ุญุตุฉ 1</button>
        <button class="lesson-btn" onclick="setLesson(2, this)">ุญุตุฉ 2</button>
        <button class="lesson-btn" onclick="setLesson(3, this)">ุญุตุฉ 3</button>
        <button class="lesson-btn" onclick="setLesson(4, this)">ุญุตุฉ 4</button>
        <button class="lesson-btn" onclick="setLesson(5, this)">ุญุตุฉ 5</button>
        <button class="lesson-btn" onclick="setLesson(6, this)">ุญุตุฉ 6</button>
        <button class="lesson-btn" onclick="setLesson(7, this)">ุญุตุฉ 7</button>
    </div>
    
    <div id="teacherStats" class="stats-bar">
        <div class="stat-item stat-n">ุงูุทูุงุจ: <b id="tTotal">0</b></div>
        <div class="stat-item stat-p">ุญุถูุฑ: <b id="tPres">0</b></div>
        <div class="stat-item stat-a">ุบูุงุจ: <b id="tAbs">0</b></div>
        <div class="stat-item stat-perc">ูุณุจุฉ ุงูุญุถูุฑ: <b id="tPercP">0%</b></div>
        <div class="stat-item stat-perc-a">ูุณุจุฉ ุงูุบูุงุจ: <b id="tPercA">0%</b></div>
    </div>
</div>

<div id="loginArea" class="card" style="display:none;">
    <input type="password" id="passInput" placeholder="ุฃุฏุฎู ุฑูุฒ ุงููุฏูุฑ...">
    <button onclick="checkPassword()" style="padding:12px; margin-top:8px; width:100%; background:var(--primary); color:white; border:none; border-radius:8px;">ุฏุฎูู ุงููุธุงู</button>
</div>

<div id="mainAppArea" class="card">
    <table class="record-table">
        <tbody id="studentsList"></tbody>
    </table>
    <button class="btn-save" onclick="pushToCloud()">ุญูุธ ุงูุบูุงุจ ุงูุขู โ</button>
</div>

<div id="adminPanel" style="display:none;">
    <div class="date-picker-container">
        <label class="class-label">๐ ุนุฑุถ ุณุฌู ููู ุณุงุจู:</label>
        <input type="date" id="adminDateSelector" class="date-input" onchange="generateDetailedReport(this.value)">
        <button class="btn-export-all" onclick="exportAllAttendanceToExcel()">๐ฅ ุญูุธ ุชูุฑูุฑ (Excel) - ุตูุญุงุช ููู ููู</button>
    </div>

    <div class="card" style="border-top: 4px solid var(--accent);">
        <label class="class-label">๐ ุงูุจุญุซ ุนู ุทุงูุจ (ุนุฑุถ ุงูุณุฌู ุงูุชุงุฑูุฎู):</label>
        <div class="search-container">
            <input type="text" id="studentSearch" class="search-input" placeholder="ุงูุชุจ ุงุณู ุงูุทุงูุจ ููุง..." oninput="handleSearch(this.value)">
            <div id="searchResults" class="search-results"></div>
        </div>
        <div id="searchHistoryDisplay"></div>
    </div>

    <div class="school-summary">
        <div class="summary-box">ุฅุฌูุงูู ุงูุทูุงุจ <span id="sTotal">0</span></div>
        <div class="summary-box">ุฅุฌูุงูู ุงูุบูุงุจ <span id="sAbs">0</span></div>
        <div class="summary-box">ูุณุจุฉ ุงูุญุถูุฑ <span id="sPresPerc">0%</span></div>
        <div class="summary-box">ูุณุจุฉ ุงูุบูุงุจ <span id="sAbsPerc">0%</span></div>
    </div>
    <div class="card" style="padding:8px; background: #f8f9fa;">
        <table class="class-table">
            <thead>
                <tr><th>ุงูุตู</th><th>ุงูุนุฏุฏ</th><th>ุญุถูุฑ</th><th>ุบูุงุจ</th><th>ูุณุจุฉ ุงูุญุถูุฑ</th><th>ูุณุจุฉ ุงูุบูุงุจ</th></tr>
            </thead>
            <tbody id="classesStatsBody"></tbody>
        </table>
    </div>
    <div id="detailedReportArea"></div>
</div>

<footer class="page-footer">
    <div style="font-size: 0.75rem; color: var(--primary);">ูุฏูุฑ ุงููุฏุฑุณุฉ ุงูุฃุณุชุงุฐ</div>
    <div style="color: #333; font-weight: 800; font-size: 1rem;">ูุดุงู ุงููุญุงูู</div>
</footer>

<script>
    const firebaseConfig = { apiKey: "AIzaSyAzmsbAn5jVh293t7X79NmyzSZFDFXFpdg", databaseURL: "https://oman-school-app-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const ALL_STUDENTS = {
        "5-1": ["ุฃุญูุฏ ุจู ุณุงูู ุจู ุณุนูุฏ ุญุณู ุฎูุงุฑ", "ุงูุฃููู ูุญูุฏ ุฃุญูุฏ ุงูุทูุจ", "ุชุฑูู ุจู ูุญูุฏ ุจู ุณุนูุฏ ูุณูู ูุณู", "ุฎุงูุฏ ุจู ุฑุงุดุฏ ุจู ุณุนูุฏ ุณุงูู ูุณู", "ุณุงูู ุจู ูุญูุฏ ุจู ุณุงูู ุตุงูุญ ุฌุฏุงุฏ", "ุณุงูู ุจู ูุณูู ุจู ุณููู ูุญูุฏ ุงูุฑุงุดุฏู", "ุณุนูุฏ ุจู ุณุงูู ุจู ุธูููุฑ ุณุงูู ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ุดูุงุจ ุจู ูุงูุน ูุณูู ุงููุณููู ุงููุซูุฑู", "ุณุนูุฏ ุจู ุนุจุฏุงููู ุจู ุจูุงู ุฎููุฏุน ุฎูุงุฑ", "ุณูุทุงู ุจู ูุญูุฏ ุจู ุนูู ูููู ุงูุนุงูุฑู", "ุนุงูุฑ ุจู ุณููู ุจู ุนุงูุฑ ุณููู ููุตูุช", "ุนุจุฏุงูุฑุญูู ุฃุญูุฏ ููุฒู ุนุจุฏุงููุชุงุญ", "ุนูู ุจู ุณุนุฏ ุจู ูุณูู ุณุนูุฏ ุงูุฑุงุดุฏู", "ุนูุถ ุจู ูุญูุฏ ุจู ุนูุถ ุฎุงุฏู ุงููููุจู", "ุบุงูู ุจู ูุญูุฏ ุจู ุณููู ูุณูู ุงูุฌููุจู", "ุบุงูู ุจู ูุญูุฏ ุจู ูุจุงุฑู ุจุฎูุช ุฌุฏุงุฏ", "ูุญูุฏ ุฃุญูุฏ ูุญููุฏ ุนุจุฏุงูุญููุฏ", "ูุญูุฏ ุจู ูุณูู ุจู ูุญูุฏ ุจุฎูุช ูุณู", "ูุงูู ุจู ูุญูุฏ ุจู ุณุงูู ุณููู ูุณู", "ููุฏุงู ุจู ุฃุญูุฏ ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ"],
        "5-2": ["ุฃุญูุฏ ุจู ุณุนูุฏ ุจู ูุณูู ุฃุญูุฏ ุฌุฏุงุฏ", "ุฃูุฌุฏ ุจู ุณุนูุฏ ุจู ุฎููุณ ุณุนูุฏ ุงูุดูููู", "ุงูุจุฑุงุก ุฃุญูุฏ ุณููุญ ุนูู ุณูุฏ", "ุฎุงูุฏ ุจู ุฃุญูุฏ ุจู ูุณูู ูุญูุฏ ูุณู", "ุฎุงูุฏ ุจู ูุญูุฏ ุจู ูุณูู ุณูููุฑ ุฎูุงุฑ", "ุณุงูู ุจู ุญูุฏ ุจู ูุจุฎูุช ุญูุงุฏู ุฌุฏุงุฏ", "ุณุงูู ุจู ุนูุถ ุจู ุณุงูู ูุญูุฏ ูุณู", "ุณุงูู ุจู ูุงูู ุจู ุณุงูู ุนูุถู ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ุจุฎูุช ุจู ุนุจุฏู ุจุฎูุช ุฎูุงุฑ", "ุณุนูุฏ ุจู ุฎุงูุฏ ุจู ุจุฎูุช ุฒุงูุฏ ูุณู", "ุณุนูุฏ ุจู ุตุงูุญ ุจู ุณููู ุนูู ุจูุช ุฌุฏุงุฏ", "ุณููุงู ุจู ูุงุฌู ุจู ุณุงูู ุณุนุฏ ุฎูุงุฑ", "ุณููู ุจู ูุนูุฑ ุจู ุณููู ูุณูู ุฌุฏุงุฏ ุงููุซูุฑู", "ุตุงูุญ ูุญูู ูุณูู", "ุตูุฑ ุจู ูุญูุฏ ุจู ุงูุนุจุฏ ุณููู ุฌุฏุงุฏ", "ุนุจุฏุงูุฑุญูู ุณุงูู ูุญูุฏ ุฃุญูุฏ ููุณู ุงููุฒูู", "ูุญูุฏ ุจู ุจุฎูุช ุจู ุฃุญูุฏ ูุญูุฏ ูุณู", "ูุญูุฏ ุจู ุณุงูู ุจู ุณููู ูุทุฑ ุฌุฏุงุฏ", "ูุญูุฏ ุจู ุนุงูุฑ ุจู ูุญูุฏ ุฃุญูุฏ ุงููุณููู", "ูุญูุฏ ุจู ุบุงุฒู ุจู ูููุด ุฌุนูุฏ ุฌุฏุงุฏ ุงููุซูุฑู", "ูุญูุฏ ุจู ููุฏ ุจู ุณุงูู ุฎููุชู ูุณู", "ูุณูู ุจู ุจุฎูุช ุจู ุนุจุฏู ุจุฎูุช ุฎูุงุฑ"],
        "5-3": ["ุฅููุงุณ ุจู ุฅุจุฑุงููู ุจู ุญูุฏ ูุณุนูุฏ ุงูุนุงูุฑู", "ุชูููุฑ ุจู ุฃุญูุฏ ุจู ูุจุฑูู ุฃุญูุฏ ูุณู", "ุฎุงูุฏ ุฃุญูุฏ ุญุณู ุงูุชุงุจุนู", "ุฎุงูุฏ ุจู ุนูุฑู ุจู ุบููู ุณุงูู ุฎูุงุฑ", "ุณุงูู ุจู ุนูุงุฏ ุงูููุณุงูู", "ุดูุงุจ ุจู ุญูุฏ ุจู ูุญูุฏ ุญูุฏ ุงูููุงุฆู", "ุนุจุฏุงููู ุจู ูุญูุฏ ุจู ุนูุธู ุณุนูุฏ ุฌุฏุงุฏ ุงููุซูุฑู", "ููุฏ ุจู ูุญูุฏ ุจู ุณุงูู ูุณูู ุงููุณููู", "ููุตู ุจู ุญูุฏ ุจู ูุญูุฏ ุญูุฏ ุงูููุงุฆู", "ูุงุฒู ูุตุทูู ูุญูุฏ ุฃุญูุฏ ุนูู", "ูุญูุฏ ุจู ุญุณูู ุจู ุณุงูู ูุจุฎูุช ุฎูุงุฑ", "ูุญูุฏ ุจู ุณุนูุฏ ุจู ุณุงูู ุฎููุชู ูุณู", "ูุฑูุงู ุณูุงูู ุญุณูู ุนูู ุดููู", "ูุณูู ุจู ุณุนูุฏ ุจู ุณุนุฏ ุณุนูุฏ ุฌุฏุงุฏ", "ูุณูู ุจู ูุญูุฏ ุจู ูุณูู ุฃุญูุฏ ุฌุฏุงุฏ", "ููุซู ุจู ููุงุฒ ุจู ุณูููุงู ุนุจุฏุงููู ุงููุงุดูู"],
        "6-1": ["ุงูุฎุทุงุจ ูุญูุฏ ุญูุฏ ุงูููู ุฃุญูุฏ", "ุงูุฎููู ุจู ุบุณุงู ุจู ุทุงูุจ ุจุฏุฑ ุงูุตูุตุงูู", "ุงููุฌุฑุณ ุจู ุณูููุงู ุจู ูุจุงุฑู ุณูููุงู ุงูุญุจุณู", "ุฃูุณ ูุญููุฏ ูุญูุฏ ุฃุญูุฏ", "ุฃูุงุจ ุนุจุฏุงูุนุธูู ุญุณูู ุงูุทุงูุฑ", "ุญุณูู ูุญูุฏ ููุณู ุฎุถุฑ", "ุณุงูู ุจู ุซุงูู ุจู ูุญูุฏ ุจุฎูุช ุฎูุงุฑ", "ุณุงูู ุจู ุญููุฏ ุจู ุณุงูู ุณุนูุฏ ุงููุงุฆูู", "ุณุงูู ุจู ูุญูุฏ ุจู ุณุงูู ุนุจุฏุงููู ุงูุฑุงุดุฏู", "ุณุนูุฏ ุจู ุนุจุฏุงูุนุฒูุฒ ุจู ุจุฎูุช ุญู ูุณู", "ุณุนูุฏ ุจู ุญุงุชู ุจู ุณุนูุฏ ูุญูุฏ ุจูุช ูุณู", "ุณุนูุฏ ุจู ูุณูู ุจู ุณุนูุฏ ุณููู ูุณู", "ุณููู ุจู ุณููู ุจู ุณููู ุณููู ููุตูุช", "ุณููู ูุญุณู ุณููู ุขู ุฎูุงุฑ", "ุณูู ุจู ุฎููุณ ุจู ุณุงูู ูุญูุฏ ุงูุฌููุจู", "ุณูู ุจู ูุงูู ุจู ุนุจุฏุงููู ูุจุงุฑู ุฌุฏุงุฏ", "ุนุจุฏ ุงูุฑุญูู ุจู ูุญูุฏ ุจู ุณุนูุฏ ุณุงูู ูุณู", "ุนุจุฏุงููู ุจู ุบุงูู ุจู ุณุงูู ุนุจุฏุงููู ุงูุฑุงุดุฏู", "ุนุจุฏุงููู ุจู ูุญูุฏ ุจู ุฃุญูุฏ ุฑูููุงู ุฎูุงุฑ", "ุนุจุฏุงููู ุนูุงุถ ุนุจุฏุงููู ุนุจุฏุงููุทูู", "ุนูู ุจู ุญุงูุฏ ุจู ูุณูู ูุญูุฏ ูุณู ุงููุซูุฑู", "ุนูู ุจู ุณุนูุฏ ุจู ูุญูุฏ ุณุงูู ุฎูุงุฑ", "ูุจุฑูู ุจู ูุญูุฏ ุจู ุณุงูู ุธูููุฑ ุฌุฏุงุฏ", "ูุชุนุจ ุจู ุณุนูุฏ ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ", "ูุญูุฏ ุจู ุฌููู ุจู ุนุจุฏู ุจุฎูุช ุฎูุงุฑ", "ูุณูู ุจู ุจุฏุฑ ุจู ูุณูู ุณุนูุฏ ูุณู", "ูุณูู ุจู ูุญูุฏ ุจู ูุณูู ุณุนูุฏ ุฌุฏุงุฏ"],
        "6-2": ["ุงูููุซ ุจู ุฅุจุฑุงููู ุจู ูุงุตุฑ ุนูู ุงูุญูุณูู", "ุงููุบูุฑู ุจุดุฑู ูุญุฌูุจ ุฃุญูุฏ", "ุจุฎูุช ุจู ุณุนูุฏ ุจู ูุจุงุฑู ุจุฎูุช ุฌุฏุงุฏ", "ุณุงูู ุจู ุฃุญูุฏ ุจู ุณููู ุณุงูู ุฎูุงุฑ", "ุณุงูู ุจู ุญุงุชู ุจู ุณุงูู ุณุนุฏ ุฎูุงุฑ", "ุณุงูู ุจู ุณูุทุงู ุจู ุณููู ุบุงูู ุงูุฑุงุดุฏู", "ุณุงูู ุจู ุณููู ุจู ุณุงูู ุงููุญูุงุก ุฌุฏุงุฏ", "ุณุนุฏ ุจู ูุฑุงูู ุจู ุณุงูู ุนูู ุฎูุงุฑ", "ุณุนูุฏ ุจู ุนุงุฏู ุจู ุณุงูู ุฎููุชู ูุณู ุจูุช ูุซูุฑ", "ุณูุทุงู ุจู ูุณูู ุจู ุณูุทุงู ุฃุณุฏ ุงูุฑุงุดุฏู", "ุนุงูุฑ ุจู ุฎุงูุฏ ุจู ุณุงูู ูุณู", "ุนุจุฏุงููู ุจู ุญุณูู ุจู ุนูู ูุญูุฏ ุขู ุนุจุฏุงูุณูุงู", "ุนุจุฏุงููู ุจู ุนุจุฏู ุจู ุจุฎูุช ุฒููุฉ ุฎูุงุฑ", "ุนุจุฏุงููู ุณุนูุฏุงู ุณูุนุฏ ุงูุฑุงุดุฏู", "ุบุงุฒู ุจู ูุญูุฏ ุจู ุตุงูุญ ุฃุญูุฏ ุฌุฏุงุฏ", "ุบูุซ ุจู ุฃุญูุฏ ุจู ุจุฎูุช ูุนููู ุงููุณููู", "ูุงุฒู ุชุงูุฑ ูุญูุฏ ูุญูุฏ ุนููุด", "ูุงุฒู ุนุจุฏุงูุณููุน ุณูููุงู ุฎููุณ", "ูุงูุฑ ุจู ูุญูุฏ ุจู ูุณุชููู ูุญูุฏ ุตูุฑุงุฑ", "ูุญูุฏ ุจู ุนุจุฏุงููู ุจู ูุญูุฏ ุนุจุฏุงููู ุฎูุงุฑ", "ูุญูุฏ ุญุงูุธ ุณุนูุฏ ุฑุนููุช", "ูุญูุฏ ูุญุณู ุณููู ุขู ุฎูุงุฑ", "ูุฏุฑู ุจู ุฎุงูุฏ ุจู ุณุนูุฏ ุจุฎูุช ุงูุดุนุดุนู", "ูุณูู ุจู ุณุงูู ุจู ุนุจุฏุงููู ุณุนูุฏ ุงูุฑุงุดุฏู", "ูุณูู ุจู ูุญูุฏ ุจู ุณุนูุฏ ูุณูู ุฌุฏุงุฏ", "ููุณู ุจู ูุญูุฏ ุจู ุจุฎูุช ุณุงูู ุฎูุงุฑ", "ููุณู ุนูุงุฏ ุงูููุณุงูู"],
        "7-1": ["ุฃุญูุฏ ุฃูุฌุฏ ุฃุญูุฏ ุฃุญูุฏ ูุฌุงุฏ", "ุฃุญูุฏ ุจู ุณุนูุฏ ุจู ุตุงูุญ ุฃุญูุฏ ุฌุฏุงุฏ", "ุงูุนุจุฏ ุจู ูุญูุฏ ุจู ุงูุนุจุฏ ุฒุงุฆุฏ ูุณู", "ุงููุงุจู ุจู ูุญูุฏ ุจู ุณุงูู ุณููู ูุณู", "ุจุฎูุช ุจู ุฃุญูุฏ ุจู ุจุฎูุช ูุฑูุญ ูุณู ุงููุซูุฑู", "ุชููู ุจู ูุญูุฏ ุจู ุณููู ุฌุฏูุฏ ุฌุฏุงุฏ ุงููุซูุฑู", "ุชููู ุจู ูุญูุฏ ุจู ูุจุฑูู ุนุจุฏุงููู ุงููุณููู", "ุญูุฏ ุจู ูุญูุฏ ุจู ุฃุญูุฏ ุงููุฒุงุฑ ุงููุซูุฑู", "ุญูุฏ ุจู ูุญูุฏ ุจู ุณุนูุฏ ูุณู", "ุฑุงุดุฏ ุจู ูุญูุฏ ุจู ุฃุญูุฏ ูุญูุฏ ูุณู ุงููุซูุฑู", "ุณุงูู ุจู ุณุนุฏ ุจู ุตูุงุญ ุฑุนููุช", "ุณุนูุฏ ุจู ุดูุงุจ ุจู ุฃุญูุฏ ูุญูุฏ ูุณู", "ุณุนูุฏ ุจู ูุญูุฏ ุจู ุตุงูุญ ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ูุญูุฏ ุจู ูุจุงุฑู ุจุฎูุช ุฌุฏุงุฏ", "ุณูุทุงู ุจู ุญูุฒุฉ ุจู ูุณูู ููู ุฑุจุนุงุช ุงููุซูุฑู", "ุนุงูุฑ ุจู ูุญูุฏ ุจู ูุณูู ุจุฎูุช ุงููุณููู", "ุนุจุฏุงููู ุจู ุณุงูู ุจู ุณููู ุณููู ููุตูุช", "ุนูุฑ ุฃุญูุฏ ูุญูุฏ ุฃุญูุฏ", "ุนูุฑ ุนุจุฏุงูููู ุฅุจุฑุงููู ุฅุจุฑุงููู", "ูุฑูุญ ุจู ุนุจุฏุงููู ุจู ูุฑูุญ ุฃุญูุฏ ูุณู", "ูุฌุชุจู ุนูุณู ูุญูุฏ", "ูุณูู ุจู ูุญูุฏ ุจู ุนูุถ ุฎุงุฏู ุงููููุจู", "ูุงุตุฑ ุจู ุณุงูู ุจู ุธูููุฑ ุณุงูู ุฌุฏุงุฏ", "ูุงุณุฑ ุจู ุนุงุฏู ุจู ุณุงูู ูุณู ุจูุช ูุซูุฑ", "ููุณู ุนูุฑ ุฃุญูุฏ ุนุจุฏ ุงูุฑุญูู ุญุงูู"],
        "7-2": ["ุฅุจุฑุงููู ูุญูุฏ ุณุงูู ุงูุณุทุฑู", "ุงูุนุจุงุณ ุจู ูุจุฎูุช ุจู ุณุงูู ูุณู ุจูุช ูุซูุฑ", "ุงูููุฐุฑ ุจู ููุงุฒ ุจู ุณูููุงู ุนุจุฏุงููู ุงููุงุดูู", "ุฃููุฑ ุจู ูุงุตุฑ ุจู ุนุจุฏุงูุฑุญูู ุนุจุฏุงููู ุงูุจููุดู", "ุญุณูู ุณูุงูู ุญุณูู ุนูู ุดููู", "ุฎุงูุฏ ุจู ุณุงูู ุจู ุนูู ุนุจุฏุงููู ุงูุนููู", "ุฎุงูุฏ ุจู ูุญูุฏ ุจู ุณููู ูุทุฑ ุฌุฏุงุฏ", "ุฎุงูุฏ ุจู ูุณูู ุจู ุฃุญูุฏ ุฌุฏุงุฏ", "ุฑููุฒู ุจู ูุณูู ุจู ุจุฎูุช ุฑููุฒู ุตูุฏู ุงููุญุฑูู", "ุณุงูู ุจู ูุจุงุฑู ุจู ุณููู ูุญูุฏ ุงูุฑุงุดุฏู", "ุณุนุฏ ุจู ูุญูุฏ ุจู ุณุนุฏ ุญููุธ ุฎูุงุฑ", "ุณุนูุฏ ุจู ุนุจุฏุงููู ุจู ุจุฎูุช ุฒุงุฆุฏ ูุณู", "ุณุนูุฏ ุจู ุนุจุฏุงููู ุจู ุณุงูู ุฃุญูุฏ ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ูุณูู ุจู ุนุจุฏุงููู ุณุนูุฏ ุฌุฏุงุฏ", "ุณูุทุงู ุจู ูุณูู ุจู ุณุงูู ุตุงูุญ ุฌุฏุงุฏ", "ุนุจุฏุงููู ุจู ุนุงุฑู ุจู ุณุงูู ุฌุฏุงุฏ", "ุนูู ุจู ุณุนูุฏ ุจู ุนูู ุฎูุงุฑ", "ุนูุฑ ูุคุงุฏ ูููู ูุญูุฏ ูุคุงุฏ", "ููุฏ ุจู ุบุงูู ุจู ุณุงูู ุฌุฏุงุฏ", "ูุญุณู ูุนุชุตู ูุญูุฏ ุงูุฅูุงู", "ูุญูุฏ ุจู ุณุงูู ุจู ูุจุฎูุช ูุญูุฏ ุงูุฑุงุดุฏู", "ูุณูู ุจู ุณุงูู ุจู ุณููู ุงูุฑุงุดุฏู", "ูุตุทูู ูุญููุฏ ูุฑูู ุฅุจุฑุงููู ุฃุญูุฏ", "ูุนุงุฐ ุฃุญูุฏ ุณููุญ ุนูู ุณูุฏ", "ูููู ุจู ุณุนูุฏ ุจู ูุญูุฏ ุณุงูู ุฌุฏุงุฏ", "ูุงุฏู ุจู ุณุนูุฏ ุจู ูุงุฏู ุญุณู ุดุญุฑู ุฎูุงุฑ", "ูุงุฆู ุจู ุญููุฏ ุจู ุณุงูู ุณุนูุฏ ุงููุงุฆูู"],
        "7-3": ["ุฃุญูุฏ ุจู ูุงูู ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ", "ุงูุทูุญ ุจู ุณุงูู ุจู ุญุณู ุนูู ุฎูุงุฑ", "ุจุฎูุช ุจู ูุณูู ุณุงูู ูุจุฎูุช ุงูุฑุงุดุฏู", "ุจุฏุฑ ุจู ุนุงูุฑ ุจู ูุณูู ุงูุฑุญุงุจู ุฌุฏุงุฏ", "ุญุซูุซ ุจู ุณูุทุงู ุจู ูุญูุฏ ุณููู ูุณู", "ุญูุฏ ุจู ูุญูุฏ ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ ุงููุซูุฑู", "ุณุงูู ุจู ุฃุญูุฏ ุจู ุณุงูู ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ูุจุฑูู ุจู ุณุงูู ุนุงูุฑ ุงููุณููู", "ุณููู ุจู ุนุจุฏุงููู ุจู ุณููู ุญุงูุธ ุฎูุงุฑ", "ุนุจุฏ ุงููู ุฃููุฑ ุนุจุฏุงููู ูุงุตุฑ", "ุนุจุฏุงููู ุจู ูุญูุฏ ุจู ุนูู ูููู ุงูุนุงูุฑู", "ุนูู ุจู ุซุงูู ุจู ุนูู ุณุงูู ุฌุฏุงุฏ ุจูุช ูุซูุฑ", "ูุงุฑุณ ุฒูุงุฏ ูุญูุฏ ุฃุจู ุฑูุงุน", "ูุจุงุฑู ุจู ุณุนูุฏ ุจู ุณุงูู ุฎููุชู ูุณู", "ูุญุณู ุจู ุนููู ุจู ุณุงูู ุณุนุฏ ุฎูุงุฑ", "ูุญูุฏ ุจู ุจุฎูุช ุจู ูุฑุฌ ุงูุณูุญ ุดููุงู ุงูููุฑู", "ูุญูุฏ ุจู ุนูู ุจู ุจุฎูุช ูุญูุฏ ุงูุฑุงุดุฏู", "ูุญูุฏ ุจู ุบุงูู ุจู ุงูุฑุถู ุณูุงูู ุฌุฏุงุฏ", "ูุญูุฏ ุจู ูุณูู ุจู ูุญูุฏ ูุณูู ุฌุฏุงุฏ", "ูุญูุฏ ุจู ูุงุตุฑ ุจู ุนุจุฏุงููู ุฌุฏุงุฏ", "ูุญูุฏ ุจู ููุซู ุจู ุณุงูู ูุงุฆู ุฌุฏุงุฏ ุงููุซูุฑู", "ูุณูู ุจู ุญุณู ุจู ูุงุฏู ุญุณู ุดุญุฑู ุฎูุงุฑ", "ูุนุงุฐ ูุคุงุฏ ุงูุญููุด ุงูุฃุญูุฏ", "ูุงุตุฑ ุจู ุนูู ุจู ูุงุตุฑ ุณููู ุฌุฏุงุฏ", "ููุฑ ุงูุฏูู ูุณูู ุงูุนูู", "ููุซู ุจู ูุญูุฏ ุจู ุณุงูู ูุงุฆู ุฌุฏุงุฏ"],
        "8-1": ["ุฃุญูุฏ ุจู ุณุนูุฏ ุจู ุจุฎูุช ุตูุฏู ุงููุญุฑูู", "ุฃุญูุฏ ุจู ุนุงูุฑ ุจู ูุญูุฏ ุณุงูู ุฎูุงุฑ", "ุฃุญูุฏ ุจู ูุญูุฏ ุจู ุณุงูู ูุจุงุฑู ุงููุณููู", "ุงููุฑ ุจู ุบุงูู ุจู ูุญูุฏ ุณููู ุงููุณููู ุงููุซูุฑู", "ุฅูุงุฏ ุฃุญูุฏ ุชูููู ุนุจุงุณ ูุตุทูู", "ุจุฎูุช ุจู ุฎุงูุฏ ุจู ุจุฎูุช ุฒุงุฆุฏ ูุณู", "ุจุฎูุช ุจู ุณุนูุฏุงู ุจู ุจุฎูุช ุฑููุฒู ุตูุฏู ุงููุญุฑูู", "ุญุงูู ุจู ููุฏ ุจู ุณุงูู ุฎููุชู ูุณู", "ุญุฑูุฒ ุจู ูุญุณู ุจู ุตุงูุญ ุญุฑูุฒ ุฎูุงุฑ", "ุญูุฏ ุจู ูุญูุฏ ุจู ุงูุนุจุฏ ุณููู ุฌุฏุงุฏ", "ุญูุฏ ุจู ูุญูุฏ ุจู ุณุนุฏ ุณุนูุฏ ุฌุฏุงุฏ", "ุญูุฏุงู ุจู ูุญูุฏ ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ", "ุฒุงูุฏ ุจู ูุญูุฏ ุจู ูุณูู ุณุนูุฏ ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ุฃุญูุฏ ุจู ูุญูุฏ ุงูุทูู ุงููุฒุงุฑ ุงููุซูุฑู", "ุณุนูุฏ ุจู ุญุงุชู ุจู ุณุนูุฏ ูุญูุฏ ุจูุช ูุณู", "ุณุนูุฏ ุจู ูุญูุฏ ุจู ุตุงูุญ ุฃุญูุฏ ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ุนุจุฏุงููู ุจู ูุจุฎูุช ุญูุงุฏู ุฌุฏุงุฏ", "ุณููู ุจู ุตุงูุญ ุจู ุจุฎูุช ุตุงูุญ ูููู ุฎูุงุฑ", "ุณููู ุจู ูุญุณู ุจู ุณููู ูุญููุธ ุฎูุงุฑ", "ุณููู ุจู ูุญูุฏ ุจู ุณุงูู ุนูู ุงูุญูุฑ", "ุณูู ุจู ุนุจุฏุงููู ุจู ูุณูู ูุญูุฏ ูุณู ุงููุซูุฑู", "ูุงุฆู ุจู ูุญูุฏ ุจู ูุงุฆู ูุทุฑ ุฌุฏุงุฏ", "ูุญูุฏ ุฅุณูุงุนูู ุขุฏู ุนูู", "ูุญูุฏ ุจู ุณุงูู ุจู ุณุนูุฏ ุงููุญูุงุก ุฌุฏุงุฏ", "ูุญูุฏ ุจู ุณุนุฏ ุจู ูุณูู ุณุนูุฏ ุงูุฑุงุดุฏู", "ูุญูุฏ ุจู ูุณูู ุจู ุณุนูุฏ ุจุฎูุช ูุณู", "ูุญูุฏ ุจู ูุณูู ุจู ุณููู ูุทุฑ ุฌุฏุงุฏ", "ูุญูุฏ ูุตุทูู ุนุจุฏุงููุจู ุนุจุฏู", "ูุณูู ุจู ุญูุฏ ุจู ุณููู ูุณูู ุงูุฌููุจู", "ูุทุฑ ุจู ุนูู ุจู ุณุงูู ุนุงูุฑ ุงููุณููู", "ูุงุตุฑ ุจู ุณุงูู ุจู ูุญูุฏ ุงูุทูู ุงููุซูุฑู", "ุตุงูุญ ุฌุนูุฑ ุตุงูุญ ุนุจุฏ ุงููู"],
        "8-2": ["ุงูุฌููุฏู ุจู ููุธุงู ุจู ุณูููุงู ุณุงูู ุงููุงุตุฑู", "ุงูุฎุทุงุจ ูุญูุฏ ุตูุงุญ ูุญููุฏ", "ุชููู ุจู ููุซู ุจู ุฃุญูุฏ ุณุนูุฏ ูุณู ุงููุซูุฑู", "ุฎุงูุฏ ุจู ูุญูุฏ ุจู ุณุงูู ุฃุญูุฏ ุฌุฏุงุฏ", "ุฎุงูุฏ ุจู ูุงูู ุจู ุณุงูู ุนูุถุฉ ุฌุฏุงุฏ", "ุฑูุงุถ ุจู ุจุฎูุช ุจู ูุฑุฌ ุดููุงู ุนุฒุงุจ", "ุณุงูู ุจู ุญุงูุฏ ุจู ูุณูู ูุญูุฏ ูุณู ุงููุซูุฑู", "ุณุงูู ุจู ุนุงูุฑ ุจู ุณุงูู ุธูููุฑ ุฌุฏุงุฏ", "ุณุงูู ุณููู ุณุงูู ูุฑุฌ ุงูุฎูุงุฑ", "ุณุนุฏ ุจู ุญุงูู ุจู ุฃุญูุฏ ุฎูุงุฑ", "ุณุนูุฏ ุจู ุณุงูู ุจู ุณุนูุฏ ุณููู ูุณู", "ุณุนูุฏ ุจู ูุงูู ุจู ุนุจุฏุงููู ูุญูุฏ ุฌุฏุงุฏ", "ุณุนูุฏ ุจู ุฑุงูุงู ุจู ูุณูู ูุญูุฏ ูุณู ุงููุซูุฑู", "ุตุงูุญ ุจู ุนูู ุจู ุตุงูุญ ุนูู ุงููุณููู", "ุทุงุฑู ุฃุญูุฏ ุถุงุญู ุนุจุฏุงูุบูู ุญุณูู", "ุทูุงู ุจู ูุณูู ุจู ุณุนูุฏ ุณููู ูุณู", "ุนุงูุฑ ุจู ุฃุญูุฏ ุจู ูุจุฎูุช ูุณูู ูููู ุฎูุงุฑ", "ุนุจุฏุงูุนุฒูุฒ ุจู ููุตู ุจู ุณุนูุฏ ูุญูุฏ ุงููุณููู", "ุนุจุฏุงููู ุจู ุณุงูู ุจู ุฃุญูุฏ ุตุงูุญ ูุณู", "ุนูู ุฌูุนุงู ุณุงูู ุณุนูุฏ ููุณู", "ุนูุฑ ุจู ูุญูุฏ ุจู ุณูููุงู ูุญูุฏ ุงูููุฏู", "ุบููู ุจู ุนูุฑู ุจู ุบููู ุณุงูู ุฎูุงุฑ", "ูุงูู ูููุฏ ูุญูุฏ ูุคุงุฏ", "ูุญูุฏ ุจู ุณุนูุฏ ุจู ุตุงูุญ ุฃุญูุฏ ุฌุฏุงุฏ", "ูุญูุฏ ุจู ูุณูู ุจู ุณููู ูุญูุฏ ุงูุฑุงุดุฏู", "ูุณูู ุจู ุฃุญูุฏ ุจู ูุณูู ุงูุฑุญุงุจู ุฌุฏุงุฏ", "ูุงุตุฑ ุจู ูุฑุดุฏ ุจู ุจุฎูุช ุนุจุฏุงููู ูุณู", "ูุงู ุจู ูุญูุฏ ุจู ุณุงูู ุจุฎูุช ุงููุซูุฑู", "ููุณู ุจู ุณุงูู ุจู ุนุงูุฑ ุณูุงูู ุฌุฏุงุฏ", "ูุญูุฏ ุญุณูู ุงูุนูู"]
    };

    let selectedLesson = 1; 
    let dKey = new Date().toISOString().split('T')[0];

    function updateClock() {
        const now = new Date();
        document.getElementById('liveDate').innerText = now.toLocaleDateString('ar-OM');
        document.getElementById('liveTime').innerText = now.toLocaleTimeString('ar-OM', { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    function handleSearch(val) {
        const resultsDiv = document.getElementById('searchResults');
        if (val.length < 2) { resultsDiv.style.display = 'none'; return; }
        let matches = [];
        Object.keys(ALL_STUDENTS).forEach(cls => {
            ALL_STUDENTS[cls].forEach(name => { if (name.includes(val)) matches.push({ name, cls }); });
        });
        if (matches.length > 0) {
            resultsDiv.innerHTML = matches.map(m => `<div class="search-item" onclick="viewStudentHistory('${m.name}', '${m.cls}')"><b>${m.name}</b> <small>(${m.cls})</small></div>`).join('');
            resultsDiv.style.display = 'block';
        } else { resultsDiv.innerHTML = '<div class="search-item">ูุง ููุฌุฏ ูุชุงุฆุฌ</div>'; resultsDiv.style.display = 'block'; }
    }

    function viewStudentHistory(name, cls) {
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('studentSearch').value = name;
        const display = document.getElementById('searchHistoryDisplay');
        display.innerHTML = "<p style='text-align:center;'>ุฌุงุฑู ูุญุต ุงูุณุฌูุงุช...</p>";
        database.ref('attendance').once('value', (snap) => {
            const allData = snap.val() || {};
            let html = `<table class="history-table"><thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุญุงูุฉ</th></tr></thead><tbody>`;
            let totalAbs = 0;
            const studentIdx = ALL_STUDENTS[cls].indexOf(name);
            Object.keys(allData).sort().reverse().forEach(date => {
                if (allData[date][cls]) {
                    let isAbsent = false;
                    for (let l = 1; l <= 7; l++) { if (allData[date][cls]['L' + l]?.[studentIdx]?.status === 'a') { isAbsent = true; break; } }
                    if (isAbsent) { totalAbs++; html += `<tr><td>${date}</td><td style="color:red; font-weight:bold;">ุบุงุฆุจ</td></tr>`; }
                }
            });
            if (totalAbs === 0) html += `<tr><td colspan="2">ูุง ููุฌุฏ ุณุฌู ุบูุงุจ ููุฐุง ุงูุทุงูุจ</td></tr>`;
            html += `</tbody></table><div style="margin-top:10px; font-weight:bold; color:var(--danger)">ุฅุฌูุงูู ุฃูุงู ุงูุบูุงุจ: ${totalAbs}</div>`;
            display.innerHTML = html;
        });
    }

    function setLesson(num, btn) {
        selectedLesson = num;
        document.querySelectorAll('.lesson-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchClassData();
    }

    function fetchClassData() {
        const cls = document.getElementById('classSelect').value;
        if(!cls) return;
        database.ref(`attendance/${dKey}/${cls}/L${selectedLesson}`).once('value', (snap) => {
            const data = snap.val() || {};
            const list = document.getElementById('studentsList');
            list.innerHTML = "";
            ALL_STUDENTS[cls].forEach((name, i) => {
                let status = data[i]?.status || 'p';
                list.innerHTML += `<tr>
                    <td style="font-size:0.85rem; font-weight:500;">${name}</td>
                    <td>
                        <select id="stat${i}" class="status-select status-${status}" onchange="this.className='status-select status-'+this.value; updateTeacherStats('${cls}')">
                            <option value="p" ${status=='p'?'selected':''}>ุญุงุถุฑ</option>
                            <option value="a" ${status=='a'?'selected':''}>ุบุงุฆุจ</option>
                            <option value="l" ${status=='l'?'selected':''}>ูุชุฃุฎุฑ</option>
                        </select>
                    </td>
                </tr>`;
            });
            document.getElementById('mainAppArea').style.display = "block";
            updateTeacherStats(cls);
        });
    }

    function updateTeacherStats(cls) {
        const total = ALL_STUDENTS[cls].length;
        let abs = 0;
        ALL_STUDENTS[cls].forEach((_, i) => { if(document.getElementById('stat'+i)?.value === 'a') abs++; });
        let pres = total - abs;
        document.getElementById('teacherStats').style.display = 'grid';
        document.getElementById('tTotal').innerText = total;
        document.getElementById('tPres').innerText = pres;
        document.getElementById('tAbs').innerText = abs;
        document.getElementById('tPercP').innerText = Math.round((pres/total)*100) + '%';
        document.getElementById('tPercA').innerText = Math.round((abs/total)*100) + '%';
    }

    function pushToCloud() {
        const cls = document.getElementById('classSelect').value;
        if(!cls) return alert("ุงุฎุชุฑ ุงูุตู ุฃููุงู!");
        let data = {};
        ALL_STUDENTS[cls].forEach((_, i) => { data[i] = { status: document.getElementById('stat'+i).value }; });
        database.ref(`attendance/${dKey}/${cls}/L${selectedLesson}`).set(data).then(() => alert("ุชู ุญูุธ ุงูุบูุงุจ ุจูุฌุงุญ โ"));
    }

    function adminShortcut() {
        let count = window.clickCount || 0; count++; window.clickCount = count;
        if (count === 3) { document.getElementById('loginArea').style.display = "block"; window.clickCount = 0; }
        setTimeout(() => { window.clickCount = 0; }, 2000);
    }

    function checkPassword() {
        if(document.getElementById('passInput').value === "12345678910") {
            document.getElementById('loginArea').style.display = "none";
            document.getElementById('adminPanel').style.display = "block";
            document.getElementById('adminDateSelector').value = dKey;
            generateDetailedReport(dKey);
        } else { alert("ุงูุฑูุฒ ุบูุฑ ุตุญูุญ"); }
    }

    function generateDetailedReport(targetDate) {
        let displayDate = targetDate || dKey;
        database.ref('attendance/' + displayDate).on('value', (snap) => {
            const data = snap.val() || {};
            const statsTable = document.getElementById('classesStatsBody');
            const detailArea = document.getElementById('detailedReportArea');
            statsTable.innerHTML = ""; detailArea.innerHTML = "";
            let sTotal = 0, sAbs = 0;
            
            Object.keys(ALL_STUDENTS).sort().forEach(clsId => {
                let absSet = new Set(), lateSet = new Set();
                let cTotal = ALL_STUDENTS[clsId].length;
                sTotal += cTotal;
                for(let l=1; l<=7; l++) {
                    if(data[clsId]?.['L'+l]) {
                        ALL_STUDENTS[clsId].forEach((name, i) => {
                            if(data[clsId]['L'+l][i]?.status === 'a') absSet.add(name);
                            if(data[clsId]['L'+l][i]?.status === 'l') lateSet.add(name);
                        });
                    }
                }
                
                let cAbs = absSet.size; sAbs += cAbs;
                statsTable.innerHTML += `<tr><td>${clsId}</td><td>${cTotal}</td><td>${cTotal-cAbs}</td><td style="color:red">${cAbs}</td><td>${Math.round(((cTotal-cAbs)/cTotal)*100)}%</td><td>${Math.round((cAbs/cTotal)*100)}%</td></tr>`;

                let namesHtml = "";
                absSet.forEach(name => {
                    namesHtml += `
                    <div class="student-absent-row">
                        <span style="font-weight:bold; font-size:0.8rem;">${name}</span>
                        <button class="wa-single-btn" onclick="sendIndividualWA('${name}', '${clsId}', '${displayDate}')">
                            ๐ฌ ูุฑุงุณูุฉ ููู ุงูุฃูุฑ
                        </button>
                    </div>`;
                });
                if(namesHtml) {
                    detailArea.innerHTML += `<div class="class-report-card"><div class="class-report-header">๐ ุบูุงุจ ุตู: ${clsId}</div><div class="class-report-body">${namesHtml}</div></div>`;
                }
            });

            document.getElementById('sTotal').innerText = sTotal;
            document.getElementById('sAbs').innerText = sAbs;
            document.getElementById('sPresPerc').innerText = sTotal > 0 ? Math.round(((sTotal-sAbs)/sTotal)*100) + '%' : '0%';
            document.getElementById('sAbsPerc').innerText = sTotal > 0 ? Math.round((sAbs/sTotal)*100) + '%' : '0%';
        });
    }

    function sendIndividualWA(studentName, className, date) {
        let msg = `*ูุฏุฑุณุฉ ูุฒูุฏ ุจู ุงูุญุงุฑุซ*\n\n`;
        msg += `ููู ุฃูุฑ ุงูุทุงูุจ: *${studentName}*\n`;
        msg += `ุงูุตู: *${className}*\n\n`;
        msg += `ูุญูุทูู ุนููุงู ุจุฃู ุงูุทุงูุจ ูุณุฌู (ุบุงุฆุจ) ูู ุณุฌูุงุช ุงููุฏุฑุณุฉ ููููู: *${date}*.\n`;
        msg += `ูุฑุฌู ูููู ุชูุถูุญ ุณุจุจ ุงูุบูุงุจ ุฃู ุงูุชูุงุตู ูุน ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ.\n\n`;
        msg += `*ูุฏูุฑ ุงููุฏุฑุณุฉ ุงูุฃุณุชุงุฐ: ูุดุงู ุงููุญุงูู*`;

        const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
        const newWindow = window.open(waUrl, '_blank', 'noopener,noreferrer');
        if (newWindow) newWindow.focus();
        else alert("ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ");
    }

    function exportAllAttendanceToExcel() { alert("ูุธููุฉ ุงูุชุตุฏูุฑ ููุฏ ุงูุชุฌููุฒ..."); }
</script>
</body>
</html>
